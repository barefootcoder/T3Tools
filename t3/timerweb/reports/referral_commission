-- SORT GROUP: Commission Reports
-- TITLE: Referral Commission

print "Period from [start_date] to [end_date]"
print ""
print ""
go

$(build_profit_item "
	exists
	(
		select 1
		from invoice i
		where log.invoice_id = i.invoice_id
		and i.invoice_paydate < '[end_date]'
	)
	and not exists
	(
		select 1
		from commission com
		where log.log_source = com.log_source
		and log.log_id = com.log_id
		and com.comm_type = 'R'
	)
")
go

calc_total_price
go
calc_referral_commission
go

-- for debugging
/*
select emp, client, proj, convert(char(10), end_date, 101) "date", units,
		rca.hours, convert(numeric(6,2), price_per_unit) "price / unit",
		convert(numeric(6,2), rca.amount) "ref comm"
from profit_item pi, referral_comm_amount rca
where pi.profit_id = rca.profit_id
order by emp, client, proj, date
*/
go

-- now for the actual report
select rca.name "pay to", $(employee_name e) "employee", c.name "client",
		convert(numeric(5,2), sum(rca.hours)) "hours",
		sum(rca.amount) "total referral comm"
from profit_item pi, referral_comm_amount rca, employee e, client c
where pi.profit_id = rca.profit_id
and rca.emp = e.emp
and pi.client = c.client
group by rca.name, $(employee_name e), c.name
order by rca.name, $(employee_name e), c.name
compute sum(sum(rca.amount))
	by rca.name
compute sum(sum(rca.amount))
go
