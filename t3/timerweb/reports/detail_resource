-- SORT GROUP: Customer Reports
-- TITLE: Detailed Resource Report
-- ALSO RUN WITH: history=yes
-- SORT GROUP: Customer Reports
-- TITLE: Historical Resource Report

$(build_profit_item "
	exists												{?invoice}
	(													{?invoice}
		select 1										{?invoice}
		from invoice i									{?invoice}
		where log.invoice_id = i.invoice_id				{?invoice}
		and i.invoice_number = '{invoice}'				{?invoice}
	)													{?invoice}

	log.client = '{client}'								{!invoice}
	and log.date >= '{start_date}'						{!invoice}	{?history}
	and log.date <= '{end_date}'						{!invoice}
	and log.proj = '{proj}'								{!invoice}	{?proj}
	and not exists										{!invoice}	{!history}
	(													{!invoice}	{!history}
		select 1										{!invoice}	{!history}
		from invoice i									{!invoice}	{!history}
		where log.invoice_id = i.invoice_id				{!invoice}	{!history}
	)													{!invoice}	{!history}
")

calc_total_price
go

set nocount on
go

declare @client_header varchar(100)
select distinct @client_header
		= "<CENTER><H3>For Client: " + c.name + "</H3></CENTER>"
from profit_item pi, client c
where pi.client = c.client
print @client_header
print "<CENTER><H5>Period: {start_date} to {end_date}</H5></CENTER>" {!invoice}
print "<CENTER><H5>Invoice: {invoice}</H5></CENTER>"				{?invoice}
go

print "<HR><H4>Details by Date</H4>"
if exists
(
	select 1
	from profit_item pi, project p, project_type pt
	where pi.client = p.client
	and pi.proj = p.proj
	and pi.start_date between p.start_date and p.end_date
	and p.proj_type = pt.proj_type
	and pt.resource_billing = 1
)
	select p.name "project", ph.name "phase", rr.resource_name "resource",
			convert(char(10), tl.date, 101) "date",
			convert(numeric(6,2), pi.units) "hours"
	from profit_item pi, time_log tl, project p, phase ph, employee e,
			resource_rate rr, resource_employee re
	where pi.log_source = tl.log_source
	and pi.log_id = tl.log_id
	and pi.client = p.client
	and pi.proj = p.proj
	and pi.end_date between p.start_date and p.end_date
	and tl.phase = ph.phase
	and tl.emp = re.emp
	and
	(
		tl.phase = re.phase
		or
		(
			re.phase is NULL
			and not exists
			(
				select 1
				from resource_employee re2
				where tl.client = re2.client
				and tl.emp = re2.emp
				and tl.phase = re2.phase
				and tl.date between re2.start_date and re2.end_date
			)
		)
	)
	and tl.client = re.client
	and tl.date between re.start_date and re.end_date
	and re.client = rr.client
	and re.resrc = rr.resrc
	and tl.date between rr.start_date and rr.end_date
	and tl.emp = e.emp
	order by p.name, ph.name, rr.rate, pi.date

if exists
(
	select 1
	from profit_item pi, project p, project_type pt, time_log tl
	where pi.client = p.client
	and pi.proj = p.proj
	and pi.start_date between p.start_date and p.end_date
	and p.proj_type = pt.proj_type
	and pt.resource_billing = 0
	and pi.log_source = tl.log_source
	and pi.log_id = tl.log_id
	and tl.cliproj is not NULL
)
	select convert(char(25), p.name) "project",
			cp.name "tracking code", convert(char(25), ph.name) "phase",
			convert(char(10), tl.date, 101) "date",
			convert(numeric(6,2), pi.units) "hours"
	from profit_item pi, time_log tl, project p, phase ph, client_project cp
	where pi.log_source = tl.log_source
	and pi.log_id = tl.log_id
	and pi.client = p.client
	and pi.proj = p.proj
	and pi.end_date between p.start_date and p.end_date
	and tl.phase = ph.phase
	and tl.client = cp.client
	and tl.cliproj = cp.project_id
	order by p.name, cp.name, ph.name, pi.date
go

if exists
(
	select 1
	from profit_item pi, project p, project_type pt, time_log tl
	where pi.client = p.client
	and pi.proj = p.proj
	and pi.start_date between p.start_date and p.end_date
	and p.proj_type = pt.proj_type
	and pt.resource_billing = 0
	and pi.log_source = tl.log_source
	and pi.log_id = tl.log_id
	and tl.phase is NULL
	and tl.cliproj is NULL
)
	select p.name "project", convert(char(10), tl.date, 101) "date",
			convert(numeric(6,2), pi.units) "hours"
	from profit_item pi, time_log tl, project p
	where pi.log_source = tl.log_source
	and pi.log_id = tl.log_id
	and pi.client = p.client
	and pi.proj = p.proj
	and pi.end_date between p.start_date and p.end_date
	order by p.name, pi.date
go

print "<HR><H4>Totals by Project and Phase</H4>"

if exists
(
	select 1
	from profit_item pi, time_log tl, project p
	where pi.log_source = tl.log_source
	and pi.log_id = tl.log_id
	and pi.client = p.client
	and pi.proj = p.proj
	and pi.end_date between p.start_date and p.end_date
	and tl.phase is not NULL
)
	select p.name "project", ph.name "phase",
			convert(numeric(6,2), sum(pi.units)) "hours",
			sum(pi.total_price) "total"
	from profit_item pi, time_log tl, project p, phase ph, employee e
	where pi.log_source = tl.log_source
	and pi.log_id = tl.log_id
	and pi.client = p.client
	and pi.proj = p.proj
	and pi.end_date between p.start_date and p.end_date
	and tl.phase = ph.phase
	and tl.emp = e.emp
	group by p.name, ph.name
	order by p.name, ph.name
	compute sum(sum(pi.total_price))
		by p.name
go

if exists
(
	select 1
	from profit_item pi, time_log tl, project p
	where pi.log_source = tl.log_source
	and pi.log_id = tl.log_id
	and pi.client = p.client
	and pi.proj = p.proj
	and pi.end_date between p.start_date and p.end_date
	and tl.phase is NULL
)
	select p.name "project", convert(numeric(6,2), sum(pi.units)) "hours",
			sum(pi.total_price) "total"
	from profit_item pi, time_log tl, project p, employee e
	where pi.log_source = tl.log_source
	and pi.log_id = tl.log_id
	and pi.client = p.client
	and pi.proj = p.proj
	and pi.end_date between p.start_date and p.end_date
	and tl.emp = e.emp
	group by p.name
	order by p.name
	compute sum(sum(pi.total_price))
		by p.name
go

if exists
(
	select 1
	from profit_item pi, time_log tl
	where pi.log_source = tl.log_source
	and pi.log_id = tl.log_id
	and tl.cliproj is not NULL
)
begin
	print "<HR><H4>Totals by Project and Client Tracking Code</H4>"
	select convert(char(25), p.name) "project", cp.project_id "code",
			cp.name "tracking code description",
			convert(numeric(6,2), sum(pi.units)) "hours",
			sum(pi.total_price) "total"
	from profit_item pi, time_log tl, project p, client_project cp
	where pi.log_source = tl.log_source
	and pi.log_id = tl.log_id
	and pi.client = p.client
	and pi.proj = p.proj
	and pi.end_date between p.start_date and p.end_date
	and tl.client = cp.client
	and tl.cliproj = cp.project_id
	group by p.name, cp.project_id, cp.name
	order by p.name, cp.project_id, cp.name
	compute sum(sum(pi.total_price))
		by p.name
	print "<HR><H4>Totals by Project, Client Tracking Code, and Phase</H4>"
	select convert(char(25), p.name) "project", cp.project_id "code",
			ph.name "phase", convert(numeric(6,2), sum(pi.units)) "hours",
			sum(pi.total_price) "total"
	from profit_item pi, time_log tl, project p, client_project cp, phase ph
	where pi.log_source = tl.log_source
	and pi.log_id = tl.log_id
	and pi.client = p.client
	and pi.proj = p.proj
	and pi.end_date between p.start_date and p.end_date
	and tl.client = cp.client
	and tl.cliproj = cp.project_id
	and tl.phase = ph.phase
	group by p.name, cp.project_id, cp.name, ph.name
	order by p.name, cp.project_id, cp.name, ph.name
	compute sum(sum(pi.total_price))
		by p.name
end
go

if exists
(
	select 1
	from profit_item pi, time_log tl, project p, project_type pt,
			resource_rate rr, resource_employee re
	where pi.log_source = tl.log_source
	and pi.log_id = tl.log_id
	and tl.proj = p.proj
	and tl.date between p.start_date and p.end_date
	and p.proj_type = pt.proj_type
	and pt.resource_billing = 1
	and tl.emp = re.emp
	and
	(
		tl.phase = re.phase
		or
		(
			re.phase is NULL
			and not exists
			(
				select 1
				from resource_employee re2
				where tl.client = re2.client
				and tl.emp = re2.emp
				and tl.phase = re2.phase
				and tl.date between re2.start_date and re2.end_date
			)
		)
	)
	and tl.client = re.client
	and tl.date between re.start_date and re.end_date
	and re.client = rr.client
	and re.resrc = rr.resrc
	and tl.date between rr.start_date and rr.end_date
)
begin
	print "<HR><H4>Totals by Resource</H4>"
	select p.proj, rr.resource_name "resource",
			convert(numeric(6,2), sum(pi.units)) "hours",
			sum(pi.total_price) "total"
	from profit_item pi, time_log tl, project p, project_type pt,
			resource_rate rr, resource_employee re
	where pi.log_source = tl.log_source
	and pi.log_id = tl.log_id
	and tl.proj = p.proj
	and tl.date between p.start_date and p.end_date
	and p.proj_type = pt.proj_type
	and pt.resource_billing = 1
	and tl.emp = re.emp
	and
	(
		tl.phase = re.phase
		or
		(
			re.phase is NULL
			and not exists
			(
				select 1
				from resource_employee re2
				where tl.client = re2.client
				and tl.emp = re2.emp
				and tl.phase = re2.phase
				and tl.date between re2.start_date and re2.end_date
			)
		)
	)
	and tl.client = re.client
	and tl.date between re.start_date and re.end_date
	and re.client = rr.client
	and re.resrc = rr.resrc
	and tl.date between rr.start_date and rr.end_date
	group by p.proj, rr.rate, rr.resource_name
	order by p.proj, rr.rate desc
	compute sum(sum(pi.total_price))
end
go
