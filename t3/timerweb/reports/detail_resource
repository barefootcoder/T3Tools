-- SORT GROUP: Customer Reports
-- TITLE: Detailed Resource Report

$(build_profit_item "
	exists													??invoice
	(														??invoice
		select 1											??invoice
		from invoice i										??invoice
		where log.invoice_id = i.invoice_id					??invoice
		and i.invoice_number = '[invoice]'					??invoice
	)														??invoice

	log.client = '[client]'									?!invoice
	and log.date <= '[end_date]'							?!invoice
	and not exists											?!invoice
	(														?!invoice
		select 1											?!invoice
		from invoice i										?!invoice
		where log.invoice_id = i.invoice_id					?!invoice
	)														?!invoice
")

calc_total_price
go

set nocount on
go

declare @client_header varchar(100)
select distinct @client_header
		= "<CENTER><H3>for client: " + c.name + "</H3></CENTER>"
from profit_item pi, client c
where pi.client = c.client
print @client_header
go

print "<HR><H4>Details by Date</H4>"
select p.name "project", ph.name "phase", rr.resource_name "resource",
		convert(char(10), tl.date, 101) "date",
		convert(numeric(6,2), pi.units) "hours"
from profit_item pi, time_log tl, project p, phase ph, employee e,
		resource_rate rr, resource_employee re
where pi.log_source = tl.log_source
and pi.log_id = tl.log_id
and pi.client = p.client
and pi.proj = p.proj
and pi.end_date between p.start_date and p.end_date
and tl.phase = ph.phase
and tl.emp = re.emp
and pi.client = re.client
and tl.date between re.start_date and re.end_date
and re.client = rr.client
and re.resrc = rr.resrc
and tl.date between rr.start_date and rr.end_date
and tl.emp = e.emp
order by p.name, ph.name, rr.rate
go

print "<HR><H4>Totals by Project and Phase</H4>"
select p.name "project", ph.name "phase",
		convert(numeric(6,2), sum(pi.units)) "hours",
		sum(pi.total_price) "total"
from profit_item pi, time_log tl, project p, phase ph, employee e
where pi.log_source = tl.log_source
and pi.log_id = tl.log_id
and pi.client = p.client
and pi.proj = p.proj
and pi.end_date between p.start_date and p.end_date
and tl.phase = ph.phase
and tl.emp = e.emp
group by p.name, ph.name
order by p.name, ph.name
compute sum(sum(pi.total_price))
	by p.name
go

print "<HR><H4>Totals by Resource</H4>"
select rr.resource_name "resource",
		convert(numeric(6,2), sum(pi.units)) "hours",
		sum(pi.total_price) "total"
from profit_item pi, time_log tl, resource_rate rr, resource_employee re
where pi.log_source = tl.log_source
and pi.log_id = tl.log_id
and tl.emp = re.emp
and pi.client = re.client
and tl.date between re.start_date and re.end_date
and re.client = rr.client
and re.resrc = rr.resrc
and tl.date between rr.start_date and rr.end_date
group by rr.rate, rr.resource_name
order by rr.rate desc
compute sum(sum(pi.total_price))
go
