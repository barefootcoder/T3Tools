-- SORT GROUP: Error Checkers
-- TITLE: Database Consistency Errors

print "projects with end dates before start dates"
go
select *
from project
where end_date < start_date
go

print "projects that don't match a client"
go
select p.*
from project p
where p.client not in
(
	select c.client
	from client c
)
go

print "projects with invalid types"
go
select p.*
from project p
where p.proj_type not in
(
	select pt.proj_type
	from project_type pt
)
go

print "projects with end dates at 12/31/99"
select *
from project
where end_date = '12/31/99'
go

print "bill rates with end dates before start dates"
go
select *
from bill_rate
where end_date < start_date
go

print "bill rates that don't match any existing project"
go
select br.*
from bill_rate br
where not exists
(
	select 1
	from project p
	where p.client = br.client
	and p.proj = br.proj
)
go

print "bill rates for resource billing projects"
go
select br.*
from bill_rate br, project p, project_type pt
where br.client = p.client
and br.proj = p.proj
and p.proj_type = pt.proj_type
and pt.resource_billing = 1
go

print "bill rates with at least one date outside corresponding project dates"
go
select br.*
from bill_rate br
where not exists
(
	select 1
	from project p
	where p.client = br.client
	and p.proj = br.proj
	and br.start_date between p.start_date and p.end_date
)
or not exists
(
	select 1
	from project p
	where p.client = br.client
	and p.proj = br.proj
	and br.end_date between p.start_date and p.end_date
)
go

print "bill rates with end dates at 12/31/99"
select *
from bill_rate
where end_date = '12/31/99'
go

print "emp/resrc assignments with end dates before start dates"
go
select *
from resource_employee
where end_date < start_date
go

print "emp/resrc assignment with dates outside resource dates"
select rr.*
from resource_rate rr, resource_employee re
where rr.client = re.client
and rr.resrc = re.resrc
and
(
	re.start_date < rr.start_date
	or re.end_date > rr.end_date
)
go

print "resource rates with end dates before start dates"
go
select *
from resource_rate
where end_date < start_date
go

print "resource rates for clients with no resource billing projects"
go
select rr.*
from resource_rate rr
where not exists
(
	select 1
	from project p, project_type pt
	where rr.client = p.client
	and p.proj_type = pt.proj_type
	and pt.resource_billing = 1
)
go

print "resource rates with end dates at 12/31/99"
select *
from resource_rate
where end_date = '12/31/99'
go

print "emp/resrc assignments with end dates at 12/31/99"
select *
from resource_employee
where end_date = '12/31/99'
go

print "sales commissions that don't match any project"
select *
from sales_commission sc
where sc.proj is not NULL
and not exists
(
	select 1
	from project p
	where sc.client = p.client
	and sc.proj = p.proj
)
go

print "employees that cannot log time to Barefoot non-payable"
go
select e.*
from employee e
where not exists
(
	select 1
	from client_employee ce
	where ce.emp = e.emp
	and ce.client = '011'
)
go

print "client/employee assignments with end dates before start dates"
go
select *
from client_employee
where end_date < start_date
go

print "client/employee assignments outside project dates"
go
select ce.*
from client_employee ce
where not exists
(
	select 1
	from project p
	where ce.client = p.client
	and isnull(ce.proj, p.proj) = p.proj
	and ce.start_date between p.start_date and p.end_date
	and ce.end_date between p.start_date and p.end_date
)
go

print "log entries that don't match an employee"
go
select tl.*
from time_log tl
where tl.emp not in
(
	select e.emp
	from employee e
)
order by emp, client, proj, phase
go

print "log entries that don't match any existing project (after 1996)"
go
select tl.*
from time_log tl
where tl.date >= "1/1/1997"
and not exists
(
	select 1
	from project p
	where tl.client = p.client
	and tl.proj = p.proj
)
order by emp, client, proj, phase
go

print "log entries with illegal employee/client combinations (from 1999 on)"
go
select tl.*
from time_log tl
where tl.date >= '1/1/1999'
and not exists
(
	select 1
	from client_employee ce
	where tl.emp = ce.emp
	and tl.client = ce.client
	and tl.proj = isnull(ce.proj, tl.proj)
	and tl.date between ce.start_date and ce.end_date
)
go

print "log entries with dates outside project dates"
go
select tl.*
from time_log tl, project p
where tl.client = p.client
and tl.proj = p.proj
and not exists
(
	select 1
	from project p1
	where tl.client = p1.client
	and tl.proj = p1.proj
	and tl.date between p1.start_date and p1.end_date
)
go

set nocount on
$(build_profit_item "
	log.date >= '1/1/1999'
")
exec calc_total_price
exec calc_total_cost
set nocount off
go

print "log entries with no determinable billing rate (from 1998 on)"
go
select * from time_log_profit
where bill_rate is null
and class_billing = 0
go

print "log entries with no determinable pay rate (from 1998 on)"
go
select * from pay_amount
where requires_payment = 1
and pay_rate is null
go
