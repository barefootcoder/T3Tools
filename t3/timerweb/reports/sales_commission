-- SORT GROUP: Commission Reports
-- TITLE: Sales Commission

print "Period from [start_date] to [end_date]"
print ""
print ""
go

$(build_profit_item "
	exists
	(
		select 1
		from sales_commission sc
		where log.client = sc.client
	)
	and exists
	(
		select 1
		from invoice i
		where log.invoice_id = i.invoice_id
		and i.invoice_paydate < '[end_date]'
	)
	and not exists
	(
		select 1
		from commission com
		where log.log_source = com.log_source
		and log.log_id = com.log_id
		and com.comm_type = 'S'
	)
")

calc_total_price
go
calc_sales_commission
go

-- for debugging
/*
select pi.client, pi.proj, convert(char(10), start_date, 101) "start date",
		convert(char(10), end_date, 101) "end date", units,
		convert(numeric(6,2), price_per_unit) "cost/unit",
		convert(numeric(7,2), total_price) "total price",
		convert(numeric(6,2), sca.amount) "total sales comm",
		pi.log_source, pi.log_id
from profit_item pi, sales_comm_amount sca
where pi.profit_id = sca.profit_id
order by client, proj, start_date
*/
go

-- now for the actual report
select sca.name "salesman", sca.client "C", c.name "client", sca.proj,
		convert(numeric(8,2), sum(pi.total_price)) "total amount",
		sum(sca.amount) "total sales comm"
from sales_comm_amount sca, profit_item pi, client c
where sca.profit_id = pi.profit_id
and sca.client = c.client
group by sca.name, sca.client, c.name, sca.proj
order by sca.name, sca.client, sca.proj
compute sum(sum(sca.amount))
	by sca.name
compute sum(sum(sca.amount))
go
