-- SORT GROUP: Commission Reports
-- TITLE: Employee Commission

print "Period from [start_date] to [end_date]"
print ""
print ""
go

$(build_profit_item "
	log.date <= '[end_date]'
	and not exists
	(
		select 1
		from commission com
		where log.log_source = com.log_source
		and log.log_id = com.log_id
		and com.comm_type = 'E'
	)
")
go

calc_total_price
go
calc_sales_commission
go
calc_referral_commission
go
calc_total_cost
go
calc_employee_commission
go

-- for debugging
--/*
select eca.emp, pi.client, pi.proj,
		convert(char(10), end_date, 101) "date",
		convert(numeric(6,2), price_per_unit) "billrate",
		convert(numeric(7,2), total_price) "amt billed",
		-- convert(numeric(6,2), payrate) "payrate",
		convert(numeric(7,2), pay_to_employee) "amt paid",
		convert(numeric(7,2), diff) "diff",
		convert(numeric(7,2), amount) "empcomm"
from profit_item pi, employee_comm_amount eca
where pi.profit_id = eca.profit_id
order by emp, client, proj, date
--*/
go

-- now for the actual report
select eca.emp "E", convert(char(15), $(employee_name e)) "employee",
		pi.client "C", convert(char(25), c.name) "client",
		convert(numeric(6,2), sum(tlp.hours)) "ttl hrs",
		convert(numeric(8,2),
				sum(pi.total_price * eca.employee_percent)) "total price",
		convert(numeric(8,2), sum(eca.gross)) "total gross",
		convert(numeric(8,2), sum(eca.pay_to_employee)) "total cost",
		sum(eca.amount) "total emp comm"
from profit_item pi, employee_comm_amount eca, time_log_profit tlp,
		employee e, client c
where pi.profit_id = eca.profit_id
and pi.log_source *= tlp.log_source
and pi.log_id *= tlp.log_id
and eca.emp = e.emp
and pi.client = c.client
group by eca.emp, $(employee_name e), pi.client, c.name
order by eca.emp, pi.client
compute sum(sum(eca.amount)) by eca.emp
compute sum(sum(eca.amount))
go
