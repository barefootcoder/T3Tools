-- SORT GROUP: Management Reports
-- TITLE: Billing/Pay Rate Spreadsheet

print "Current billing and pay rates"
print "as of the current date"							?!end_date
print "as of [end_date]"								??end_date
go

declare @as_of datetime
select @as_of = getdate()								?!end_date
select @as_of = '[end_date]'							??end_date

select e.emp "E", $(employee_name e) "employee", c.client "C",
		c.name "client", p.proj "P", p.name "project",
		convert(numeric(5,2), br.rate) "billing",
		convert(numeric(5,2), pr.rate) "pay",
		isnull(brat.ratio, 1) "ratio",
		convert(numeric(5,2), br.rate - pr.rate * isnull(brat.ratio, 1)) "diff"
from employee e, client c, project p, project_type pt, client_employee ce,
		bill_rate br, pay_rate pr, billing_ratio brat
where ce.emp = e.emp
and ce.client = c.client
and @as_of between ce.start_date and ce.end_date
and e.emp = pr.emp
and isnull(pr.client, c.client) = p.client
and
(
	pr.proj = p.proj
	or
	(
		pr.proj is null
		and not exists
		(
			select 1
			from pay_rate pr2
			where pr2.emp = e.emp
			and pr2.client = c.client
			and pr2.proj = p.proj
			and @as_of between pr2.start_date and pr2.end_date
		)
	)
)
and @as_of between pr.start_date and pr.end_date
and p.client = ce.client
and p.proj = isnull(ce.proj, p.proj)
and @as_of between p.start_date and p.end_date
and p.proj_type = pt.proj_type
and pt.resource_billing = 0
and c.client = br.client
and br.proj = p.proj
and @as_of between br.start_date and br.end_date
and brat.emp =* e.emp
and brat.client =* p.client
and (brat.proj =* p.proj or brat.proj is null)
and @as_of between brat.start_date and brat.end_date
union
select e.emp "E", $(employee_name e) "employee", c.client "C",
		c.name "client", p.proj "P", p.name "project",
		convert(numeric(5,2), rr.rate) "billing",
		convert(numeric(5,2), pr.rate) "pay",
		isnull(brat.ratio, 1) "ratio",
		convert(numeric(5,2), rr.rate - pr.rate * isnull(brat.ratio, 1)) "diff"
from employee e, client c, project p, project_type pt, client_employee ce,
		resource_rate rr, resource_employee re, pay_rate pr, billing_ratio brat
where ce.emp = e.emp
and ce.client = c.client
and @as_of between ce.start_date and ce.end_date
and e.emp = pr.emp
and isnull(pr.client, c.client) = c.client
and
(
	pr.proj = p.proj
	or
	(
		pr.proj is null
		and not exists
		(
			select 1
			from pay_rate pr2
			where pr2.emp = e.emp
			and pr2.client = c.client
			and pr2.proj = p.proj
			and @as_of between pr2.start_date and pr2.end_date
		)
	)
)
and @as_of between pr.start_date and pr.end_date
and p.client = ce.client
and p.proj = isnull(ce.proj, p.proj)
and @as_of between p.start_date and p.end_date
and p.proj_type = pt.proj_type
and pt.resource_billing = 1
and c.client = rr.client
and @as_of between rr.start_date and rr.end_date
and rr.client = re.client
and rr.resrc = re.resrc
and re.emp = e.emp
and @as_of between re.start_date and re.end_date
and brat.emp =* e.emp
and brat.client =* p.client
and (brat.proj =* p.proj or brat.proj is null)
and @as_of between brat.start_date and brat.end_date
order by e.emp, c.client

print "projects open with no employee assignments"
select c.client "C", c.name "client", p.proj "P", p.name "project"
from project p, client c
where c.client = p.client
and @as_of between p.start_date and p.end_date
and not exists
(
	select 1
	from client_employee ce
	where ce.client = p.client
	and isnull(ce.proj, p.proj) = p.proj
)
go
