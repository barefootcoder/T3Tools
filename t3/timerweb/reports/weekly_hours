-- SORT GROUP: Management Reports
-- TITLE: Hours per Week (by employee/rate)

set nocount on
go

print '<H4>Hours per week</H4>'
select 'for ' + $(employee_name e)								??user
from employee e													??user
where e.login = '[user]'										??user
print 'for all employees'										?!user
select 'for ' + c.name											??client
from client c													??client
where c.client = '[client]'										??client
print 'for all clients'											?!client
print 'Period from [start_date] to [end_date]'
print ''
print ''
go


$(build_pay_amount "
	log.date between '[start_date]' and '[end_date]'
	and exists													??user
	(															??user
		select 1												??user
		from employee e											??user
		where log.emp = e.emp									??user
		and e.login = '[user]'									??user
	)															??user
	and exists													??client
	(															??client
		select 1												??client
		from client c											??client
		where log.client = c.client								??client
		and c.client = '[client]'								??client
	)															??client
")

calc_pay_amount
go

-- for debugging
/*
select emp, client, proj, convert(char(10), date, 101) "date", hours, pay_rate
from #time_log_week
order by emp, client, proj, date
*/
go

select
		$(employee_name e) "employee",							?!user
		convert(char(6), pa.pay_rate, 1) "payrate",
		c.name "client",										?!client
		$(period_name "$(period_num pa.date 7)" 7) "week",
		sum(pa.hours) "hours"
from pay_amount pa, employee e, client c
where pa.emp = e.emp
and pa.client = c.client
group by $(employee_name e), pa.pay_rate, c.name,
		$(period_name "$(period_num pa.date 7)" 7)
order by $(employee_name e), pa.payrate, c.name
compute sum(sum(pa.hours))
	by $(employee_name e), pa.payrate, c.name
go

select
		$(employee_name e) "employee",							?!user
		$(period_name "$(period_num pa.date 7)" 7) "week",
		sum(pa.hours) "hours"
from pay_amount pa, employee e
where pa.emp = e.emp
group by
		$(employee_name e),										?!user
		$(period_name "$(period_num pa.date 7)" 7),
		$(period_num pa.date 7)
order by
		$(employee_name e),										?!user
		$(period_num pa.date 7)
compute sum(sum(pa.hours))
		by $(employee_name e)									?!user
go
